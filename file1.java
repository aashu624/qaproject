modified code with some fixes.
